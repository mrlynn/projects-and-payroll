
Ext.ns('Application');Ext.onReady(function(){Ext.QuickTips.init();Ext.DatePicker.prototype.startDay=4;Ext.apply(Ext.form.VTypes,{daterange:function(val,field){var date=field.parseDate(val);if(!date){return;}
if(field.startDateField&&(!this.dateRangeMax||(date.getTime()!=this.dateRangeMax.getTime()))){var start=Ext.getCmp(field.startDateField);start.setMaxValue(date);start.validate();this.dateRangeMax=date;}
else if(field.endDateField&&(!this.dateRangeMin||(date.getTime()!=this.dateRangeMin.getTime()))){var end=Ext.getCmp(field.endDateField);end.setMinValue(date);end.validate();this.dateRangeMin=date;}
return true;}});var companyStore=new Ext.data.JsonStore({fieldLabel:'Company',id:'companyStore',url:'data.php',root:'results',baseParams:{xtable:'company',task:'getCompany',start:0,limit:100000},fields:[{name:'company_id',type:'int'},{name:'company_name'}]});var taskRecord=Ext.data.Record.create([{name:'assign_id',mapping:'assign_id'},{name:'project_id',mapping:'project_id'},{name:'task_name',mapping:'task_name'},{name:'user_id',mapping:'user_id'},{name:'company_name',mapping:'company_name'},{name:'user_firstname',mapping:'user_firstname'},{name:'user_lastname',mapping:'user_lastname'},{name:'assign_date',mapping:'assign_date'},{name:'assign_num',mapping:'assign_num'},{name:'task_priority',mapping:'task_priority'}]);var taskReader=new Ext.data.JsonReader({root:'results',totalProperty:'total',id:'assign_id'},taskRecord);var taskDS=new Ext.data.GroupingStore({id:'taskDS',proxy:new Ext.data.HttpProxy({url:'data.php',method:'POST'}),baseParams:{task:'showTasks',xtable:'task',start:0,limit:10000},reader:taskReader,sortInfo:{field:'assign_id',direction:'ASC'},groupField:'company_name'});function deleteRecord(btn){if(btn=='yes'){taskGrid=Ext.getCmp('taskGrid');var selectedKeys=taskGrid.selModel.selections.keys;Ext.Ajax.request({waitMsg:'Saving changes...',url:'data.php',params:{task:'delete',xkey:'assign_id',xtable:'assign',xid:selectedKeys},callback:function(options,success,response){if(success){Ext.MessageBox.alert('OK',response.responseText);var json=Ext.util.JSON.decode(response.responseText);Ext.MessageBox.alert('OK',json.del_count+' record(s) deleted.');}else{Ext.MessageBox.alert('Sorry, please try again. [Q304]',response.responseText);}},failure:function(response,options){Ext.MessageBox.alert('Warning','Oops...');},success:function(response,options){refreshGrid();}});}};function handleDelete(){var selectedKeys=taskGrid.selModel.selections.keys;if(selectedKeys.length>0){Ext.MessageBox.confirm('Message','Do you really want to delete this assignment?',deleteRecord);}else{Ext.MessageBox.alert('Message','Please select a task to delete');}};function refreshGrid(){taskDS.reload();}
function updateDB(oGrid_Event){if(oGrid_Event.value instanceof Date){var fieldValue=oGrid_Event.value.format('Y-m-d');}else{var fieldValue=oGrid_Event.value;}
Ext.Ajax.request({waitMsg:'Saving changes...',url:'grid-reconfigure.php',params:{task:"update",key:assign_id,xtable:'task',keyID:oGrid_Event.record.data.task_id,field:oGrid_Event.field,value:fieldValue,originalValue:oGrid_Event.record.modified},failure:function(response,options){Ext.MessageBox.alert('Warning','Oops...');},success:function(response,options){if(oGrid_Event.record.data.task_id==''){var responseData=Ext.util.JSON.decode(response.responseText);var newID=responseData.newID;oGrid_Event.record.set('newRecord','no');oGrid_Event.record.set('task_id',newID);ds.commitChanges();}else{ds.commitChanges();}}});};function handleEdit(editEvent){var gridField=editEvent.field;updateDB(editEvent);if(gridField=='price'){getTax(editEvent);}}
function addRecord(){var r=new taskRecord({task_id:'',task_description:''});taskGrid.stopEditing();taskDS.insert(0,r);taskGrid.startEditing(0,1);};function addSchedule(){var scheduledate={xtype:'datefield',fieldLabel:'Date',name:'scheduledate',id:'scheduledate',format:'Y-m-d'};var projectStore=new Ext.data.JsonStore({id:'projectStore',url:'data.php',root:'results',baseParams:{xtable:'project',start:0,limit:10000,task:'showProjects'},fields:[{name:'project_id',type:'int'},{name:'project_name'}]});var projectEdit=new Ext.form.ComboBox({id:'projectEdit',triggerAction:'all',typeAhead:false,store:projectStore,displayField:'project_name',valueField:'project_id',hiddenName:'project_id',labelSeparator:null,fieldLabel:'Project:',listClass:'x-combo-list-small',allowBlank:false,mode:'remote',forceSelection:true,listeners:{keyup:{buffer:150,fn:function(field,e){if(Ext.EventObject.ESC==e.getKey()){field.onTriggerClick();}else{var val=this.getRawValue();var re=new RegExp('%'+val+'%');projectStore.clearFilter();projectStore.filter('project_name',val,true,false);}}}}});var hour_num=new Ext.form.TextField({name:'hour_num',fieldLabel:'Hours'});var userStore=new Ext.data.JsonStore({id:'userStore',url:'data.php',root:'results',baseParams:{xtable:'user',start:0,limit:10000,task:'showUsers'},fields:[{name:'user_id',type:'int'},{name:'username'}]});var userEdit=new Ext.form.ComboBox({id:'userEdit',triggerAction:'all',store:userStore,displayField:'username',valueField:'user_id',hiddenName:'user_id',labelSeparator:null,fieldLabel:'Employee:',listClass:'x-combo-list-small',allowBlank:false,forceSelection:true,typeAhead:true,mode:'remote',listeners:{keyup:{buffer:150,fn:function(field,e){if(Ext.EventObject.ESC==e.getKey()){field.onTriggerClick();}else{var val=this.getRawValue();var re=new RegExp('%'+val+'%');userStore.clearFilter();userStore.filter('username',val,true,false);}}}}});var createTimeSheet=new Ext.form.Checkbox({fieldLabel:'Add Timesheet?',name:'addtimesheet',value:'yes',checked:true});var dr=new Ext.FormPanel({frame:true,height:180,id:'dr',width:300,labelWidth:100,lazyRender:true,url:'data.php',baseParams:{xtable:'task',task:'scheduleTask'},bodyStyle:'padding:5px',defaults:{labelWidth:100,width:170},defaultType:'datefield',items:[scheduledate,userEdit,projectEdit,hour_num,createTimeSheet],buttons:[{text:'Add Schedule',handler:function(){dr.getForm().submit({success:function(f,a){Ext.Msg.alert('Success','Schedule Successfully Created');dr.getForm().reset();},failure:function(f,a){Ext.Msg.alert('Warning','Schedule Not Successfully Created');}});}},{text:'Cancel',handler:function(){winPanel.hide();}}]});var winPanel=Ext.getCmp('winPanel');if(!winPanel){var winPanel=new Ext.Window({title:'Add Schedule',id:'winPanel',autoHeight:true,width:310,resizable:false,closable:true,modal:true,items:[dr]});}
winPanel.onShow=function(){dr=Ext.getCmp('dr');dr.getForm().reset();winPanel.show();}
winPanel.onClose=function(){dr=Ext.getCmp('dr');dr.getForm().reset();}
winPanel.show();};function handleDateRange(start,end){d1=start.format('Y-m-d');if(end){d2=end.format('Y-m-d');}else{d2=d1;}
taskDS.baseParams.startdate=d1;taskDS.baseParams.enddate=d2;taskDS.load({params:{start:0,limit:90}});}
var myMaxDate=Date.parse('today+10years');function renderDate(value){return Date.parseDate(value,"Y-m-d").format('m/d/Y');}
var taskname_edit=new Ext.form.TextField();var taskColumnModel=new Ext.grid.ColumnModel([{header:"Date",width:120,dataIndex:'assign_date',sortable:true,hidden:false,renderer:renderDate},{header:"First Name",width:130,dataIndex:'user_firstname',sortable:true,hidden:false},{header:"Last Name",width:130,dataIndex:'user_lastname',sortable:true,hidden:false},{header:"Company",width:160,dataIndex:'company_name',sortable:true,hidden:false},{header:"Project",width:190,dataIndex:'task_name',sortable:true,hidden:false},{header:"Hours",width:100,dataIndex:'assign_num',sortable:true,hidden:false}]);var datePicker=new Ext.menu.DateMenu({usePickerPlus:true,noOfMonth:1,markWeekends:true,multiSelection:true,markNationalHolidays:true,useQuickTips:false,strictRangeSelect:true,renderTodayButton:true,showToday:false,handler:function(dp,date){var allStringDates=[];var dateParam='';if(Ext.isDate(date)){allStringDates.push(date.format('Y-m-d'));}else{Ext.each(date,function(c){allStringDates.push(c.format('Y-m-d'));},this);}
for(var i=0;i<allStringDates.length;i++){if(i==0){dateParam=allStringDates[i];}else{dateParam=dateParam+','+allStringDates[i];}}
company_id=Ext.getCmp('company_id');taskDS.baseParams.company_id=company_id.value;taskDS.baseParams.dateParam=dateParam;taskDS.load({params:{start:0,limit:90}});}});var startDate=new Ext.form.DateField({format:'Y-m-d',fieldLabel:'From Date',id:'startDate',startDay:4,name:'startDate',width:140,allowBlank:false,vtype:'daterange',emptyText:'From Date...',endDateField:'endDate'});var endDate=new Ext.form.DateField({format:'Y-m-d',fieldLabel:'To Date',id:'endDate',startDay:4,name:'endDate',width:140,allowBlank:false,vtype:'daterange',emptyText:'To Date...',startDateField:'startDate'});var selectCompany=function(value){taskDS.baseParams.company_id=value.value;};var clearCompany=function(){taskDS.baseParams.company_id='';};var companyCombo=new Ext.form.ClearableComboBox({fieldLabel:'Company',emptyText:'(All Companies)',displayField:'company_name',valueField:'company_id',forceSelection:true,typeAhead:true,store:'companyStore',id:'company_id',triggerAction:'all',selectOnFocus:true,listeners:{'select':selectCompany,'cleared':clearCompany}});var taskGrid=new Application.WSSGrid({id:'taskGrid',loadMask:true,stripeRows:true,border:false,autoSizeColumns:true,cellclick:function(){var record=taskGrid.getStore().getAt(rowIndex);var fieldName=taskGrid.getColumnModel().getDataIndex(columnIndex);var data=record.get(fieldName);Ext.MessageBox.alert('title','inside function');},autoWidth:true,autoScroll:true,clickstoEdit:1,sm:new Ext.grid.RowSelectionModel({singleSelect:true}),height:300,store:taskDS,cm:taskColumnModel,border:false,autoExpandColumn:'Name',trackMouseOver:true,tbar:[companyCombo,'-',startDate,endDate,'-',{text:'Generate Report',iconCls:'go',xtype:'button',handler:function(){taskDS.baseParams.startDate=startDate.value;taskDS.baseParams.endDate=endDate.value;taskDS.load({params:{start:0,limit:90}});}},{text:'Add Schedule',tooltip:'Click to Add Schedule',iconCls:'calendar_add',handler:addSchedule},'-',{text:'Delete Selected',tooltip:'Click to Delete selected row(s)',handler:handleDelete,iconCls:'calendar_delete'},'-',{text:'Refresh',tooltip:'Click to Refresh the table',handler:refreshGrid,iconCls:'reload'},'-',{xtype:'trigger',triggerClass:'x-form-clear-trigger',onTriggerClick:function(){this.setValue('');if(taskDS){taskDS.clearFilter();}},id:'taskfilter',enableKeyEvents:true,listeners:{keyup:{buffer:150,fn:function(field,e){if(Ext.EventObject.ESC==e.getKey()){field.onTriggerClick();}else{if(taskDS){var val=this.getRawValue();var re=new RegExp('%'+val+'%');taskDS.clearFilter();taskDS.filter('task_name',val,true,false);}}}}}}],view:new Ext.grid.GroupingView({forceFit:true,groupTextTpl:'{text} ({[values.rs.length]} {[values.rs.length > 1 ? "Items" : "Item"]})'})});taskGrid.addListener('afteredit',handleEdit);Ext.apply(Ext.form.VTypes,{daterange:function(val,field){var date=field.parseDate(val);if(!date){return;}
if(field.startDateField&&(!this.dateRangeMax||(date.getTime()!=this.dateRangeMax.getTime()))){var start=Ext.getCmp(field.startDateField);start.setMaxValue(date);start.validate();this.dateRangeMax=date;}else if(field.endDateField&&(!this.dateRangeMin||(date.getTime()!=this.dateRangeMin.getTime()))){var end=Ext.getCmp(field.endDateField);end.setMinValue(date);end.validate();this.dateRangeMin=date;}
return true;}});var viewport=new Ext.Viewport({layout:'border',id:'vp',items:[{region:'north',height:0},{region:'center',layout:'fit',id:'centerpanel',autoScroll:true,frame:false,border:false,items:[taskGrid]}]});});