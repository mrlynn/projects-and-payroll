
var global_printer=null;function printmygridGO(obj){global_printer.printGrid(obj);}
function printmygridGOcustom(obj){global_printer.printCustom(obj);}
Ext.ns('Application');Ext.onReady(function(){Ext.QuickTips.init();var loadMask=new Ext.LoadMask(Ext.getBody(),{msg:"Please wait..."});setTimeout(function(){Ext.get('loading').remove();Ext.get('loading-mask').fadeOut({remove:true});},250);var companyStore=new Ext.data.JsonStore({id:'companyStore',url:'data.php',root:'results',baseParams:{task:'getCompany',xtable:'company',start:0,limit:1000},fields:[{name:'company_id',type:'int'},{name:'company_name'}]});var projectRecord=Ext.data.Record.create([{name:'project_id',mapping:'project_id',sortDir:'ASC',sortType:'asInt'},{name:'project_name',mapping:'project_name'},{name:'project_num',mapping:'project_num',sortDir:'ASC',sortType:'asInt'},{name:'company_id',mapping:'company_id'},{name:'company_name',mapping:'company_name'},{name:'project_startdate',mapping:'project_startdate',type:'date',dateFormat:'Y-m-d'},{name:'project_enddate',mapping:'project_enddate',type:'date',dateFormat:'Y-m-d'},{name:'project_cost',mapping:'project_cost'},{name:'labor_cost',mapping:'labor_cost'}]);var projectsReader=new Ext.data.JsonReader({root:'results',totalProperty:'total',id:'project_id'},projectRecord);projectsDS=new Ext.data.GroupingStore({id:'projectsDS',proxy:new Ext.data.HttpProxy({url:'data.php',method:'POST'}),baseParams:{task:'showProjects',xtable:'project',start:0,limit:1000},reader:projectsReader,sortInfo:{field:'company_id',direction:'DSC'},groupField:'company_name'});var uploadForm=new Ext.form.FormPanel({id:'uploadForm',url:'project_import.php',method:'post',labelAlign:'left',border:false,fileUpload:true,frame:false,height:120,layout:'form',layoutConfig:{align:'stretch'},autoWidth:true,autoHeight:true,bodyStyle:'padding: 5px;',items:[{xtype:'checkbox',name:'failonerror',id:'failonerror',fieldLabel:'Fail on errors?'},{xtype:'textfield',inputType:'file',fieldLabel:'Projects CSV',width:220,id:'csv',name:'csv'}],buttons:[{text:'Import',handler:function(button,event){failID=Ext.getCmp('failonerror');fileID=Ext.getCmp('csv');Ext.getCmp('uploadForm').form.submit({waitMsg:'Importing Projects...',success:function(form,action){response=Ext.util.JSON.decode(action.response.responseText);Ext.Msg.alert('Success',response.message);uploadWindow=Ext.getCmp('uploadWindow');uploadWindow.hide();projectsDS.reload();},failure:function(form,action){response=Ext.util.JSON.decode(action.response.responseText);Ext.Msg.alert('Warning','Project Import Failed<br>'+response.message);}});}}]});function handleUpload(){uploadWindow=Ext.getCmp('uploadWindow');if(!uploadWindow){uploadWindow=new Ext.Window({title:'Upload Projects CSV File',id:'uploadWindow',width:410,height:150,resizable:false,closable:true,modal:true,closeAction:'hide',items:[uploadForm]});}
uploadWindow.show();uploadWindow.onClose=function(){uploadWindow.hide();}};function handleDelete(){var selectedKeys=projectsgrid.selModel.selections.keys;if(selectedKeys.length>0){Ext.MessageBox.confirm('Message','Do you really want to delete this project?',deleteRecord);}else{Ext.MessageBox.alert('Message','Please select a project to delete');}};function refreshGrid(){projectsDS.reload();}
function updateDB(oGrid_Event){if(oGrid_Event.value instanceof Date){var fieldValue=oGrid_Event.value.format('Y-m-d');}else{var fieldValue=oGrid_Event.value;}
Ext.Ajax.request({waitMsg:'Saving changes...',url:'data.php',params:{task:"updateProject",xtable:'projects',keyID:oGrid_Event.record.data.project_id,field:oGrid_Event.field,value:fieldValue,originalValue:oGrid_Event.record.modified},failure:function(response,options){Ext.MessageBox.alert('Warning','Oops...');},success:function(response,options){if(oGrid_Event.record.data.project_id==''){var responseData=Ext.util.JSON.decode(response.responseText);var newID=responseData.newID;oGrid_Event.record.set('newRecord','no');oGrid_Event.record.set('project_id',newID);projectsDS.commitChanges();}else{projectsDS.commitChanges();}}});};function handleEdit(editEvent){var gridField=editEvent.field;if(gridField=='company_name'){var r=companyEdit.findRecord('company_name',editEvent.value);editEvent.record.set('company_id',r?r.get('company_id'):null);};updateDB(editEvent);if(gridField=='price'){getTax(editEvent);}}
function addRecord(){var r=new projectRecord({project_id:'',project_num:'',company_name:'',project_name:'',project_startdate:(new Date()).clearTime(),project_enddate:(new Date()).clearTime(),project_cost:0});projectsGrid.stopEditing();projectsDS.insert(0,r);projectsGrid.startEditing(0,1);};var money=function(val){return Ext.util.Format.number(val,'$?0,000.00?');}
var labor_money=function(val){return Ext.util.Format.number(val,'$?0,000.00?');}
var projectname_edit=new Ext.form.TextField({emptyText:'Project Name...'});var projectcost_edit=new Ext.form.TextField({emptyText:'Project Cost...'});var projectnum_edit=new Ext.form.TextField({emptyText:'Project Number...'});var project_startdate_edit=new Ext.form.DateField({format:'Y-m-d'});var project_enddate_edit=new Ext.form.DateField({format:'Y-m-d'});var companyEdit=new Ext.form.ComboBox({id:'companyEdit',triggerAction:'all',store:companyStore,displayField:'company_name',valueField:'company_id',hiddenName:'company_id',labelSeparator:null,listClass:'x-combo-list-small',allowBlank:false});Ext.util.Format.comboRenderer=function(combo){return function(value){console.log(value);var record=combo.findRecord(combo.valueField,value);return record?record.get(combo.displayField):combo.valueNotFoundText;}}
var projectsColumnModel=new Ext.grid.ColumnModel([{header:"ID",width:30,dataIndex:'project_id',sortable:true,hidden:true},{header:"Project Number",width:48,dataIndex:'project_num',editor:projectnum_edit,sortable:true,hidden:false},{header:"Company",width:90,dataIndex:'company_name',editor:companyEdit,sortable:true,hidden:false},{header:'Project Name',width:130,dataIndex:'project_name',editor:projectname_edit,sortable:true,hidden:false},{header:"Start Date",width:50,type:'date',renderer:Ext.util.Format.dateRenderer('Y-m-d'),dataIndex:'project_startdate',editor:project_startdate_edit,sortable:true,hidden:false},{header:"End Date",width:50,type:'date',renderer:Ext.util.Format.dateRenderer('Y-m-d'),dataIndex:'project_enddate',editor:project_enddate_edit,sortable:true,hidden:false},{header:"Materials Cost",align:'right',width:60,dataIndex:'project_cost',editor:projectcost_edit,renderer:money,sortable:true,hidden:false},{header:"Labor To Date",align:'right',width:60,dataIndex:'labor_cost',renderer:labor_money,sortable:true,hidden:false}]);var projectsGrid=new Application.WSSGrid({cellclick:function(){var record=projectsGrid.getStore().getAt(rowIndex);var fieldName=projectsGrid.getColumnModel().getDataIndex(columnIndex);var data=record.get(fieldName);Ext.MessageBox.alert('title','inside function');},store:projectsDS,cm:projectsColumnModel,bbar:new Ext.PagingToolbar({pageSize:300,store:projectsDS,displayInfo:true,displayMsg:'Displaying Projects {0} - {1} of {2}',emptyMsg:"No data to display"}),tbar:[{text:'Add Project',tooltip:'Click to Add a row',iconCls:'project_add',handler:addRecord},'-',{text:'Upload Projects',tooltip:'Upload Projects for Point of Sale',handler:handleUpload,iconCls:'brick_go'},'-',{text:'Delete Selected',tooltip:'Click to Delete selected row(s)',handler:handleDelete,iconCls:'project_delete'},'-',{text:'Refresh',tooltip:'Click to Refresh the table',handler:refreshGrid,iconCls:'reload'},{xtype:'tbseparator'},{xtype:'button',text:'Print',id:'downloadpdf',tooltip:'Print Projects Report',icon:'images/icons/printer.png',enableKeyEvents:true,handler:basic_printGrid},'-',{xtype:'trigger',triggerClass:'x-form-clear-trigger',onTriggerClick:function(){this.setValue('');projectsDS.clearFilter();},id:'projectsfilter',enableKeyEvents:true,listeners:{keyup:{buffer:150,fn:function(field,e){if(Ext.EventObject.ESC==e.getKey()){field.onTriggerClick();}else{var val=this.getRawValue();var re=new RegExp('%'+val+'%');projectsDS.clearFilter();projectsDS.filter('project_name',val,true,false);}}}}}],viewConfig:{emptyText:'No Projects To Display'},view:new Ext.grid.GroupingView({forceFit:true,emptyText:'No Projects to Display',groupTextTpl:'{text} ({[values.rs.length]} {[values.rs.length > 1 ? "Items" : "Item"]})'})});projectsDS.load();projectsGrid.addListener('afteredit',handleEdit);var viewport=new Ext.Viewport({stateId:'viewport-stateid',stateful:true,layout:'border',defaults:{collapsible:false,split:true},items:[{region:'center',id:'centerpanel',layout:'fit',frame:false,border:false,autoScroll:true,items:[projectsGrid]}]});function basic_printGrid(){global_printer=new Ext.grid.XPrinter({grid:projectsGrid,pathPrinter:'./printer',pdfEnable:true,hasrowAction:false,localeData:{Title:'Wall Systems Supply',subTitle:'Payroll and Scheduling Systems - Projects Report',footerText:'&copy 2010 - Wall Systems Supply, Priviledged and Confidential Information',pageNo:'Page # ',printText:'Print',closeText:'Close',pdfText:'PDF'},useCustom:{custom:false,customStore:null,columns:[],alignCols:[],pageToolbar:null,useIt:false,showIt:false,location:'bbar'},showdate:true,showdateFormat:'Y-F-d H:i:s',showFooter:true,styles:'default'});global_printer.prepare();};});
